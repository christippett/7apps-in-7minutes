steps:
  - id: docker-pull
    name: gcr.io/cloud-builders/docker
    entrypoint: "bash"
    args: ["-c", "docker pull gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest || exit 0"]
  - id: docker-build
    name: gcr.io/cloud-builders/docker
    args:
      - build
      - --cache-from=gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest
      - --tag=gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA
      - --tag=gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest
      - .
  - id: docker-push
    name: gcr.io/cloud-builders/docker
    args: ["push", "gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA"]
  - id: gomplate-config
    name: hairyhenderson/gomplate
    args: ["-f", "app.tmpl", "-o", "app.yaml"]
    env:
      - "IMAGE=gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA"
      - "APP=${_APP}"
      - "DOMAIN=${_DOMAIN}"
  - id: kubectl-apply
    name: gcr.io/cloud-builders/kubectl
    args: ["apply", "-f", "app.yaml"]
    env:
      - "CLOUDSDK_COMPUTE_ZONE=${_ZONE}"
      - "CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER}"

images:
  - gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest
  - gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA
timeout: 3600s
options:
  substitution_option: ALLOW_LOOSE
substitutions:
  _ZONE: australia-southeast1-a
  _CLUSTER: gke-cluster
  _IMAGE_NAME: 7apps-dashboard
  _DOMAIN: 7apps.cloud
  _APP: dashboard
