<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>7Apps — Google Cloud</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.materialdesignicons.com/5.3.45/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css"
    />
    <link href="/static/index.css?ts={{ unix_timestamp }}" rel="stylesheet" />
  </head>

  <body>
    <div class="container">
      <section class="level is-mobile mb-5">
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Servian</p>
            <p class="title">
              <a class="has-text-grey-darker" href="https://www.servian.com">
                <span class="icon is-large">
                  <i class="mdi mdi-48px mdi-home-city"></i>
                </span>
              </a>
            </p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">christippett.dev</p>
            <p class="title">
              <a
                class="has-text-grey-darker"
                href="https://www.christippett.dev"
              >
                <span class="icon is-large">
                  <i class="mdi mdi-48px mdi-face-profile"></i>
                </span>
              </a>
            </p>
          </div>
        </div>
        <div class="level-item has-text-centered is-hidden-mobile">
          <div>
            <p id="stopwatch" class="mb-2">00:00:00</p>
            <p>
              <button id="start" class="button is-dark">
                <span class="icon">
                  <i class="mdi mdi-play"></i>
                </span>
                <span>Start</span>
              </button>
              <button id="stop" class="button is-dark">
                <span class="icon">
                  <i class="mdi mdi-stop"></i>
                </span>
                <span>Stop</span>
              </button>
              <button id="pause" class="button is-dark">
                <span class="icon">
                  <i class="mdi mdi-pause"></i>
                </span>
                <span>Pause</span>
              </button>
              <button id="reset" class="button is-dark">
                <span class="icon">
                  <i class="mdi mdi-refresh"></i>
                </span>
                <span>Reset</span>
              </button>
            </p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">GitHub</p>
            <p class="title">
              <a
                class="has-text-grey-darker"
                href="https://github.com/servian/7apps7minutes"
              >
                <span class="icon is-large">
                  <i class="mdi mdi-48px mdi-github"></i>
                </span>
              </a>
            </p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Medium</p>
            <p class="title">
              <a
                class="has-text-grey-darker"
                href="https://medium.com/weareservian"
              >
                <span class="icon is-large">
                  <i class="mdi mdi-48px mdi-book-open-page-variant"></i>
                </span>
              </a>
            </p>
          </div>
        </div>
      </section>
        <section class="columns is-multiline">
          {% for name, src in iframes.items() %}
          <div class="column is-half">
            <div class="iframe-container">
              <div class="iframe-src">
                <a target="_blank" rel="noopener noreferrer" href="{{ src }}"
                  >{{ src }}</a
                >
              </div>
              <div
                id="service-{{ loop.index }}"
                class="iframe-mask px-6 py-6 is-size-6 has-text-weight-medium has-text-centered is-invisible"
              >
                <p class="heading">🛑 {{ name }}</p>
                <p class="title"></p>
              </div>
              <iframe
                name="{{ unix_timestamp }}-{{ loop.index }}"
                id="{{ loop.index }}"
                src="{{ src }}?ts={{ unix_timestamp }}"
                data-id="{{ loop.index }}"
                data-url="{{ src }}"
              >
              </iframe>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
  </body>
  <script src="/static/easytimer.min.js"></script>
  <script>
    var serviceMap = new Map();
    var timer = new easytimer.Timer();

    async function checkService(iframeElement) {
      const maskEl = document.getElementById(
        `service-${iframeElement.dataset.id}`
      );
      const parentEl = iframeElement.parentElement;
      const src = iframeElement.dataset.url;
      const timestamp = Date.now();

      // get latest commit sha from app
      var response;
      try {
        response = await fetch(src, {
          cache: "no-cache",
          headers: { "Accept-Language": "application/json" },
        })
      } catch {
        // mask iframe with error message
        maskEl.classList.remove("is-invisible");
        maskEl.getElementsByClassName("title")[0].innerText = "Error fetching URL";
        return;
      }
      if (response == undefined || !response.ok) {
        // mask iframe with http status
        maskEl.classList.remove("is-invisible");
        maskEl.getElementsByClassName("title")[0].innerText = response.status;
        return;
      } else {
        maskEl.classList.add("is-invisible");
      }
      const data = await response.json();
      const currentVer = serviceMap.get(src);
      const newVer = data.commit_sha;

      if (newVer !== currentVer) {
        console.log(`🕵️ new version detected on ${src} (${newVer})`);
        serviceMap.set(src, newVer);

        // cache-bust iframe
        iframeElement.name = `${iframeElement.name.split("-")[0]}-${timestamp}`;
        iframeElement.src = `${src}?ts={timestamp}`; // refresh iframe

        // animate iframe if a new version is detected
        if (currentVer !== undefined) {
          parentEl.classList.add("has-new-version");
          setTimeout(() => parentEl.classList.remove("has-new-version"), 3000);
        }
      }
    }

    async function serviceLoop() {
      var iframes = document.getElementsByTagName("iframe");
      for (var i = 0, max = iframes.length; i < max; i++) {
        checkService(iframes[i])
      }
      setTimeout(serviceLoop, 2000);
    }

    serviceLoop();

    document.getElementById("start").click(() => timer.start());
    document.getElementById("pause").click(() => timer.pause());
    document.getElementById("stop").click(() => timer.stop());
    document.getElementById("reset").click(() => {
      timer.reset();
      timer.stop();
    });
    timer.addEventListener("secondsUpdated", (e) => {
      document
        .getElementById("stopwatch")
        .innerText(timer.getTimeValues().toString());
    });
    timer.addEventListener("started", (e) => {
      document
        .getElementById("stopwatch")
        .innerText(timer.getTimeValues().toString());
    });
    timer.addEventListener("reset", (e) => {
      timer.stop();
      document
        .getElementById("stopwatch")
        .innerText(timer.getTimeValues().toString());
    });
  </script>
</html>
