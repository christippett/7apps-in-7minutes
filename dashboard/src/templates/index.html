{% with %} {% if not debug %} {% set asset_suffix = "?ts=" + unix_timestamp|string %} {%
endif %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>7Apps — Google Cloud</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css"
    />
    <link href="/static/index.css{{ asset_suffix }}" rel="stylesheet" />
    <script
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"
      defer
    ></script>
  </head>

  <body>
    <section class="container is-flex">
      <div class="columns is-desktop is-centered">
        <div
          x-data="{ tab: 'timeline' }"
          class="content-container column is-narrow has-text-grey is-relative"
        >
          <div class="content">
            <p class="title is-4">7-Apps in 7-minutes</p>
            <p class="subtitle is-6">
              One codebase. Seven services.
            </p>
          </div>
          <nav class="mb-5">
            <div class="tabs">
              <ul>
                <li :class="{ 'is-active': tab === 'overview' }">
                  <a @click="tab = 'overview'">
                    <span>Overview</span>
                  </a>
                </li>
                <li :class="{ 'is-active': tab === 'timeline' }">
                  <a @click="tab = 'timeline'">
                    <span>Timeline</span>
                  </a>
                </li>
              </ul>
            </div>
          </nav>
          <div>
            <div x-show="tab === 'overview'">
              {% include "content/overview.html" %}
            </div>
            <div x-show="tab === 'timeline'">
              {% include "content/timeline.html" %}
            </div>
          </div>
        </div>
        <div class="iframe-container column columns is-multiline">
          {% include "content/iframes.html" %}
        </div>
      </div>
    </section>
    <footer>
      <div class="content has-text-centered has-text-grey">
        <p>
          Source on
          <a href="https://github.com/servian/7apps7minutes" target="_blank">GitHub</a>.
          Licensed
          <a href="http://opensource.org/licenses/mit-license.php" target="_blank">MIT</a>
        </p>
      </div>
    </footer>
  </body>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/labella/1.1.4/labella.min.js"
    integrity="sha512-CvciuHWpGI0ygZhWN/t/zqiiDI26Zclrsqcd77VDLYN5MyfyyPvy18eFwWZZUdUgofBi/vbOKUAqPRIJ7GyO0g=="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"
    integrity="sha512-FHsFVKQ/T1KWJDGSbrUhTJyS1ph3eRrxI228ND0EGaEp6v4a/vGwPWd3Dtd/+9cI7ccofZvl/wulICEurHN1pg=="
    crossorigin="anonymous"
  ></script>
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
  <script src="/static/utils.js{{ asset_suffix }}"></script>
  <script src="/static/timeline.js{{ asset_suffix }}"></script>
  <script>
    /* eslint-disable no-undef */
    function appBuilder() {
      return {
        buildId: null,
        themeOpt: 0,
        gradients: {{ app_service.gradients|tojson }},
        googleFonts: {{ app_service.google_fonts|tojson }},
        asciiFonts: {{ app_service.ascii_fonts|tojson }},
        isActive: {{ app_service.build.has_active_builds()|tojson }},
        isLoading: false,
        isFullscreen: false,
        styleOpts: ["primary", "success", "info", "warning", "danger"],
        tooltip: { text: null, styles: {} },
        showTooltip: false,
        init() {
          WebFont.load({ google: { families: this.googleFonts } });
        },
        toggleTooltip(text, style = "primary", timeout = 5000) {
          this.tooltip.text = text
          this.styleOpts.forEach((t) => {
            this.tooltip.styles[`has-background-${t}-light`] = t === style;
            this.tooltip.styles[`has-text-${t}-dark`] = t === style;
          })
          this.showTooltip = true;
          setTimeout(() => (this.showTooltip = false), timeout);
          // Give tooltip time to transition out before resetting text
          setTimeout(() => (this.tooltip = { text: null, styles: {} }), timeout + 2500);
        },
        toggleFullscreen() {
          this.isFullscreen = !this.isFullscreen;
        },
        selectTheme(i) {
          let optsLength = this.googleFonts.length - 1;
          if (i > optsLength) {
            this.themeOpt = 0;
          } else if (i < 0) {
            this.themeOpt = optsLength;
          } else {
            this.themeOpt = i;
          }
        },
        previewUrl() {
          let font = encodeURIComponent(this.googleFonts[this.themeOpt]);
          let asciiFont = encodeURIComponent(this.asciiFonts[this.themeOpt]);
          let gradient = encodeURIComponent(this.gradients[this.themeOpt]);
          return `http://localhost:8080?font=${font}&ascii_font=${asciiFont}&gradient=${gradient}`;
        },
        async deploy() {
          this.isLoading = true;
          _.logHandler.flushLogs();
          try {
            console.debug(`🏗️ Starting Cloud Build deployment`);
            let resp = await _.appService.deployUpdate({
              gradient: this.gradients[this.themeOpt],
              asciiFont: this.asciiFonts[this.themeOpt],
              font: this.googleFonts[this.themeOpt],
            });
            let data = await resp.json();
            if (!resp.ok) throw data;
            this.buildId = data.id;
            this.isActive = true;
            console.info(`👷 Cloud Build job started (${this.buildId})`);
            this.toggleTooltip(`Cloud Build job started (${this.buildId})`, "info");
          } catch (e) {
            console.error(`👺 ${e.detail}`);
            this.toggleTooltip("Unable to trigger Cloud Build deployment", "danger");
          } finally {
            this.isLoading = false;
          }
        },
      };
    }

    // Add callback to update timeline during app deployments
    _.appService.addSubscription(({ app, duration }) => {
      console.log(`📈 Adding ${app.name} to timeline`);
      _.timeline.push({
        id: app.name,
        label: app.title,
        theme: app.theme,
        value: duration,
      });
    });
  </script>
</html>
{% endwith %}
